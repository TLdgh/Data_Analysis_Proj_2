---
title: "Untitled"
author: "Yang Lyu"
date: "11/10/2023"
output: pdf_document
---

```{r}
library(dplyr)
library(plotly)
```

```{r}
data <- read.csv("ab_data.csv")
head(data)
```

```{r}
summary(data)
print("Number of rows in data: ")
# num of rows in data
nrow(data)
# num of missing
print("Number of missing values: ")
sum(is.na(data))
```

```{r}
mimic3d <- read.csv("mimic3d.csv")
#View(data)
nrow(mimic3d)*0.8 # take 47180 rows as training, rest 20% as  patients.csv
training <- mimic3d[1:47180,]
head(training)
tail(training)
patients <- data[47181:nrow(mimic3d),]
head(patients)
```

```{r}
old <- data %>% filter(landing_page == "old_page" & group == "control")
new <- data %>% filter(landing_page == "new_page" & group == "treatment")
count(old,old$converted == 1)
count(new, new$converted == 1)
```

```{r}
nrow(old)
old[!duplicated(old$user_id),]
```

```{r}
old_distinct <- old %>% distinct(old$user_id, .keep_all = TRUE)
new_distinct <- new %>% distinct(new$user_id, .keep_all = TRUE)
```

```{r}
prop_old <- sum(old_distinct$converted == 1)/nrow(old_distinct)
nrow(old_distinct)
sum(old_distinct$converted==1)
prop_new <- sum(new_distinct$converted == 1)/nrow(new_distinct)
nrow(new_distinct)
sum(new_distinct$converted==1)
prop_old
prop_new
```

```{r}
prop <- data.frame(
  langing_page = c("Old Page", "New Page"),
  proportion = c(prop_old, prop_new)
)
# plot data
fig_1 <- plot_ly(
  x = prop$langing_page, 
  y = prop$proportion,
  type = "bar"
) %>% layout(yaxis = list(title = "Conversion Rate"))

fig_1
```

```{r, warning=FALSE}
library(rstan)

data <- list(
  N_old = 145274,
  N_new = 145310,
  conversions_old = 17489,
  conversions_new = 17264
)

stan_code <- "
data {
  int<lower=0> N_old;
  int<lower=0> N_new;
  int<lower=0> conversions_old;
  int<lower=0> conversions_new;
}

parameters {
  real<lower=0, upper=1> p_old;
  real<lower=0, upper=1> p_new;
}

model {
  p_old ~ beta(2 + conversions_old, 20 + N_old - conversions_old);
  p_new ~ beta(2 + conversions_new, 20 + N_new - conversions_new);
}

generated quantities {
  real p_difference;
  p_difference = p_new - p_old;
}
"

stan_model <- stan_model(model_code = stan_code)

# MCMC sampling
stan_samples <- sampling(stan_model, data = data, iter = 10000, chains = 4)

# posterior result
posterior_samples <- extract(stan_samples)
p_difference <- posterior_samples$p_difference

# calculate prob of new_better
prob_new_better <- mean(p_difference > 0)

cat("\n Probability that the new page is better than the old page:", prob_new_better, "\n")

```
```{r}
p_difference <- posterior_samples$p_difference
df <- data.frame(p_difference)

# plot difference density
ggplot(df, aes(x = p_difference)) +
  geom_density(fill = "blue", alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Probability Density",
       x = "new page rate- old page rate",
       y = "Density") +
  theme_minimal()

```

```{r}
# posterior for old page
p_old <- posterior_samples$p_old
df1 <- data.frame(p_old)
# posterior for new page
p_new <- posterior_samples$p_new
df2 <- data.frame(p_new)

# plot density 
ggplot(df2) +
  geom_density(aes(x = p_old), fill = "blue", alpha = 0.5) +
  geom_density(aes(x = p_new), fill = "red", alpha = 0.5) +
  labs(title = "Probability Density",
       x = "Conversion rate",
       y = "Density") +
  annotate("text", x=0.1187, y = 300, label= "New Page") +
  annotate("text", x=0.1205, y = 300, label= "Old Page")

```

```{r}
visitor_to_old <- nrow(old_distinct)
visitor_to_new <- nrow(new_distinct)
conversion_old <- sum(old_distinct$converted)
conversion_new <- sum(new_distinct$converted)

alpha_prior <- 2
beta_prior <- 20

# calculate posterior
posterior_old <- rbeta(1000000, alpha_prior+conversion_old, beta_prior+visitor_to_old-conversion_old)
posterior_new <- rbeta(1000000, alpha_prior+conversion_new, beta_prior+visitor_to_new-conversion_new)

# calculate new rate - old rate
mean(posterior_new > posterior_old)

#Riemann sum as safety check:
sapply(seq(0.001,0.999, length.out=1000000), function(x){
    dbeta(x, alpha_prior+conversion_new,beta_prior+visitor_to_new-conversion_new)*
      pbeta(x, alpha_prior+conversion_old, beta_prior+visitor_to_old-conversion_old)})%>%sum()/1000000

```

```{r}
# plot density 
fig_2 <- ggplot() +
  geom_density(aes(x = posterior_Old$old_rate), fill = "blue", alpha = 0.5) +
  geom_density(aes(x = posterior_New$new_rate), fill = "red", alpha = 0.5) +
  geom_vline(xintercept = mean_old, linetype = "dashed", color = "blue") +
  geom_vline(xintercept = mean_new, linetype = "dashed", color = "red") +
  labs(title = "Probability Density Comparison", subtitle = "New page vs. old page",
       x = "Conversion rate",
       y = "Density") +
  annotate("text", x = 0.1187, y = 300, label= "New Page") +
  annotate("text", x = 0.1205, y = 300, label= "Old Page") +
  annotate("text", x = mean_old, y = 0, label = paste("mean of old\n", round(mean_old, 6)), vjust = 0.5, size = 3) +
  annotate("text", x = mean_new, y = 0, label = paste("mean of new\n", round(mean_new, 6)), vjust = 0.5, size = 3) +
  annotate("segment", x = mean_old, xend = mean_new, y = 500, yend = 500, colour = "black", linewidth = 2, arrow = arrow()) +
  annotate("text", x = (mean_old + mean_new)/2, y = 480, label = paste(round(mean_old-mean_new,6))) +
  scale_color_manual(values = c("red", "blue"), labels = c("new page", "old page"))

fig_2
```

```{r}
visitor_to_old <- nrow(old_distinct)
visitor_to_new <- nrow(new_distinct)
conversion_old <- sum(old_distinct$converted)
conversion_new <- sum(new_distinct$converted)
alpha_prior <- 2
beta_prior <- 20

probability <- function(n, alpha_prior, conversion_old, beta_prior, visitor_to_old, conversion_new, visitor_to_new) {
  # Generate posterior samples for old and new pages
  posterior_old <- rbeta(n, alpha_prior + conversion_old, beta_prior + visitor_to_old - conversion_old)
  posterior_new <- rbeta(n, alpha_prior + conversion_new, beta_prior + visitor_to_new - conversion_new)
  
  posterior_Old <- data.frame(old_rate=c(posterior_old))
  posterior_New <- data.frame(new_rate=c(posterior_new))
  mean_old<- mean(posterior_Old$old_rate)
  mean_new<- mean(posterior_New$new_rate)

  # Calculate the new rate - old rate
  rate_difference <- mean(posterior_new > posterior_old)

  # Calculate Riemann sum as a safety check
  riemann_sum <- sapply(seq(0.001, 0.999, length.out = n), function(x) {
    dbeta(x, alpha_prior + conversion_new, beta_prior + visitor_to_new - conversion_new) *
      pbeta(x, alpha_prior + conversion_old, beta_prior + visitor_to_old - conversion_old)
  }) %>% sum() / n

  return(list(rate_difference = rate_difference, riemann_sum = riemann_sum))
}

results <- data.frame(n = integer(0), rate_difference = numeric(0), riemann_sum = numeric(0))

for (n in seq(100, 100000, by = 100)) {
  result <- probability(n, alpha_prior, conversion_old, beta_prior, visitor_to_old, conversion_new, visitor_to_new)
  results <- rbind(results, data.frame(n = n, mean_old, mean_new))
}

print(results)
```

```{r}
posterior_Old <- data.frame(old_rate=c(posterior_old))
posterior_New <- data.frame(new_rate=c(posterior_new))
mean_old<- mean(posterior_Old$old_rate)
mean_new<- mean(posterior_New$new_rate)
mean_old
mean_new
```
