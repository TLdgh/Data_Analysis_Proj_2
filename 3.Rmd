---
title: '3'
author: "Chuhan Yue"
date: "2023-10-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(plotly)
```

```{r}
data <- read.csv("ab_data.csv")
mimic3d <- read.csv("mimic3d.csv")
df <- read.csv("train_data.csv")
```

```{r}
#cleaning data
old <- data %>% filter(landing_page == "old_page" & group == "control")
new <- data %>% filter(landing_page == "new_page" & group == "treatment")
old_distinct <- old %>% distinct(old$user_id, .keep_all = TRUE)
new_distinct <- new %>% distinct(new$user_id, .keep_all = TRUE)
```

```{r}
alpha_prior <- 2
beta_prior <- 20
```

```{r}
my_sequence<-seq(from = 100, to = 145100, by = 100)
lastdata<-data.frame()
Old_sample<-data.frame()
New_sample<-data.frame()
result<-data.frame()
for(i in my_sequence){
      sample_result<-data.frame()
      sample_indices1 <- sample(1:nrow(old_distinct), 100, replace = FALSE)
      old_sample<-old_distinct[sample_indices1, ]
      old_distinct<-old_distinct[-sample_indices1, ]
      rownames(old_distinct)<-c(1:nrow(old_distinct))
      Old_sample<-rbind(Old_sample,old_sample)
      
      sample_indices2 <- sample(1:nrow(new_distinct), 100, replace = FALSE)
      new_sample<-new_distinct[sample_indices2, ]
      new_distinct<-new_distinct[-sample_indices2, ]
      rownames(new_distinct)<-c(1:nrow(new_distinct))
      New_sample<-rbind(New_sample,new_sample)
      
      visitor_to_old <- nrow(Old_sample)
      visitor_to_new <- nrow(New_sample)
      conversion_old <- sum(Old_sample$converted)
      conversion_new <- sum(New_sample$converted)
      posterior_old <- rbeta(1000000,alpha_prior+conversion_old,beta_prior+visitor_to_old-conversion_old)       
      posterior_new <- rbeta(1000000,alpha_prior+conversion_new,beta_prior+visitor_to_new-conversion_new)
      value<-mean(posterior_new > posterior_old)
      
      posterior_Old <- data.frame(old_rate=c(posterior_old))
      posterior_New <- data.frame(new_rate=c(posterior_new))
      mean_old<- mean(posterior_Old$old_rate)
      mean_new<- mean(posterior_New$new_rate)
      
      sample_result<-cbind(i,value,mean_old,mean_new)
      result <- rbind(result, sample_result)
}
```

```{r}
plot(result[,1], result[,2], main = "converge", xlab = "X-Axis", ylab = "Y-Axis", pch = 19, col = "blue")
result$interval<-result[,3]-result[,4]
plot(result[,1], result[,5], main = "interval", xlab = "X-Axis", ylab = "Y-Axis", pch = 19, col = "blue")


```


